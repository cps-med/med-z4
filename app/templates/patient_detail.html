<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Detail - {{ settings.app.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <link rel="icon" href="/static/image/favicon-emoji.ico">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script>
        // Configure HTMX to include credentials (cookies) with all requests
        htmx.config.withCredentials = true;
    </script>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="main-nav">
        <h1>{{ settings.app.name }}</h1>
        {% if user %}
        <div class="nav-user">
            <span class="user-display">
                {{ user.display_name }} &nbsp; | &nbsp; {{ user.email }}
            </span>
            <form action="/logout" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-ghost btn-sm">Logout</button>
            </form>
        </div>
        {% endif %}
    </nav>

    <div class="container patient-detail-container">
        <!-- Back Navigation -->
        <div class="back-nav">
            <a href="/dashboard" class="back-link">‚Üê Back to Roster</a>
        </div>

        <!-- Patient Header Card -->
        <div class="card patient-header-card">
            <div class="patient-header">
                <div class="patient-header-left">
                    <h1 class="patient-name-large">{{ patient.name_display }}</h1>
                    <div class="patient-meta">
                        <span class="meta-item"><strong>ICN:</strong> {{ patient.icn }}</span>
                        <span class="meta-item"><strong>DOB:</strong> {{ patient.dob }} ({{ patient.age }} years)</span>
                        <span class="meta-item"><strong>Sex:</strong> {{ patient.sex }}</span>
                        <span class="meta-item"><strong>SSN:</strong> ***-**-{{ patient.ssn_last4 }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Actions -->
        <div class="patient-actions" style="margin: 1rem 0;">
            <button hx-get="/patient/{{ patient.icn }}/edit-form"
                    hx-target="#modal-container"
                    hx-swap="innerHTML"
                    class="btn btn-outline btn-sm">
                Edit Patient
            </button>

            <button onclick="confirmDeletePatient('{{ patient.icn }}', '{{ patient.name_display }}')"
                    class="btn btn-danger btn-sm">
                Delete Patient
            </button>
        </div>

        <!-- Vitals Section -->
        <div class="card">
            <details class="collapsible-section" open>
                <summary class="section-header">
                    <h2 class="section-title">Vital Signs ({{ vitals|length }})</h2>
                    <button class="btn btn-sm btn-outline add-btn" disabled>+ Add Vital</button>
                </summary>
                <div class="section-content">
                    {% if vitals %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Unit</th>
                                <th>Location</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vital in vitals %}
                            <tr>
                                <td>{{ vital.taken_datetime }}</td>
                                <td>{{ vital.vital_type }}</td>
                                <td>{{ vital.result_value }}</td>
                                <td>{{ vital.unit_of_measure }}</td>
                                <td>{{ vital.location_name }}</td>
                                <td>
                                    {% if vital.abnormal_flag in ['CRITICAL', 'HIGH'] %}
                                    <span class="badge badge-warning">{{ vital.abnormal_flag }}</span>
                                    {% elif vital.abnormal_flag == 'LOW' %}
                                    <span class="badge badge-info">{{ vital.abnormal_flag }}</span>
                                    {% else %}
                                    <span class="badge badge-neutral">{{ vital.abnormal_flag }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <p class="empty-message">No vital signs recorded</p>
                    </div>
                    {% endif %}
                </div>
            </details>
        </div>

        <!-- Allergies Section -->
        <div class="card">
            <details class="collapsible-section" open>
                <summary class="section-header">
                    <h2 class="section-title">Allergies ({{ allergies|length }})</h2>
                    <button class="btn btn-sm btn-outline add-btn" disabled>+ Add Allergy</button>
                </summary>
                <div class="section-content">
                    {% if allergies %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Allergen</th>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Reactions</th>
                                <th>Documented</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for allergy in allergies %}
                            <tr>
                                <td><strong>{{ allergy.allergen }}</strong></td>
                                <td>{{ allergy.type }}</td>
                                <td>
                                    {% if allergy.severity == 'SEVERE' %}
                                    <span class="badge badge-danger">{{ allergy.severity }}</span>
                                    {% elif allergy.severity == 'MODERATE' %}
                                    <span class="badge badge-warning">{{ allergy.severity }}</span>
                                    {% else %}
                                    <span class="badge badge-info">{{ allergy.severity }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ allergy.reactions }}</td>
                                <td>{{ allergy.origination_date }}</td>
                                <td>{{ allergy.historical_or_observed }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <p class="empty-message">No known allergies</p>
                    </div>
                    {% endif %}
                </div>
            </details>
        </div>

        <!-- Medications Section -->
        <div class="card">
            <details class="collapsible-section" open>
                <summary class="section-header">
                    <h2 class="section-title">Medications ({{ medications|length }})</h2>
                    <button class="btn btn-sm btn-outline add-btn" disabled>+ Add Medication</button>
                </summary>
                <div class="section-content">
                    {% if medications %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Medication</th>
                                <th>Strength</th>
                                <th>Directions</th>
                                <th>Status</th>
                                <th>Issue Date</th>
                                <th>Expires</th>
                                <th>Refills</th>
                                <th>Provider</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for med in medications %}
                            <tr>
                                <td><strong>{{ med.drug_name }}</strong></td>
                                <td>{{ med.strength }}</td>
                                <td class="sig-cell">{{ med.sig }}</td>
                                <td>
                                    {% if med.status == 'ACTIVE' %}
                                    <span class="badge badge-success">{{ med.status }}</span>
                                    {% elif med.status == 'EXPIRED' %}
                                    <span class="badge badge-neutral">{{ med.status }}</span>
                                    {% else %}
                                    <span class="badge badge-warning">{{ med.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ med.issue_date }}</td>
                                <td>{{ med.expiration_date }}</td>
                                <td>{{ med.refills_remaining }}</td>
                                <td>{{ med.provider }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <p class="empty-message">No active medications</p>
                    </div>
                    {% endif %}
                </div>
            </details>
        </div>

        <!-- Clinical Notes Section -->
        <div class="card">
            <details class="collapsible-section" open>
                <summary class="section-header">
                    <h2 class="section-title">Clinical Notes ({{ clinical_notes|length }})</h2>
                    <button class="btn btn-sm btn-outline add-btn" disabled>+ Add Note</button>
                </summary>
                <div class="section-content">
                    {% if clinical_notes %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Document Title</th>
                                <th>Class</th>
                                <th>Author</th>
                                <th>Status</th>
                                <th>Preview</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for note in clinical_notes %}
                            <tr>
                                <td>{{ note.reference_datetime }}</td>
                                <td><strong>{{ note.document_title }}</strong></td>
                                <td>{{ note.document_class }}</td>
                                <td>{{ note.author_name }}</td>
                                <td>
                                    {% if note.status == 'COMPLETED' %}
                                    <span class="badge badge-success">{{ note.status }}</span>
                                    {% elif note.status == 'UNSIGNED' %}
                                    <span class="badge badge-warning">{{ note.status }}</span>
                                    {% else %}
                                    <span class="badge badge-neutral">{{ note.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="note-preview-cell">{{ note.text_preview }}</td>
                                <td>
                                    <span class="badge {% if note.source_system == 'med-z4' %}badge-teal{% else %}badge-neutral{% endif %}">
                                        {{ note.source_system }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <p class="empty-message">No clinical notes</p>
                    </div>
                    {% endif %}
                </div>
            </details>
        </div>
    </div>

    <!-- Modal container for edit form -->
    <div id="modal-container"></div>

    <!-- Toast container for notifications -->
    <div id="toast-container"></div>

    <!-- Phase H.1: CRUD JavaScript Functions -->
    <script>
        // Close modal dialog
        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Confirm patient deletion
        function confirmDeletePatient(icn, name) {
            if (confirm(`Are you sure you want to delete patient ${name} (${icn})?\n\nThis action cannot be undone.`)) {
                // Use HTMX to send DELETE request
                htmx.ajax('DELETE', `/patient/${icn}`, {
                    target: '#modal-container',
                    swap: 'innerHTML'
                });
            }
        }

        // Listen for toast messages in HTMX responses
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Check if response contains toast element
            const toast = event.detail.target.querySelector('.toast');
            if (toast) {
                // Move toast to toast container
                const toastContainer = document.getElementById('toast-container');
                if (toastContainer) {
                    toastContainer.appendChild(toast);

                    // Auto-dismiss after 3 seconds
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                }
            }

            // Auto-focus first input field when modal opens
            if (event.detail.target.id === 'modal-container') {
                const firstInput = event.detail.target.querySelector('input:not([readonly]), select, textarea');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        });

        // Close modal when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>